<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f8ff; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .lang-switch { cursor: pointer; }
        .profile, .cart { cursor: pointer; padding: 5px 10px; }
        .product-list { max-width: 600px; margin: 20px auto; }
        .product-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff; border-radius: 5px; }
        .profile-modal, .cart-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border: 1px solid #ccc; z-index: 1000; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>
    <div class="header">
        <h2>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <div>
            <span class="lang-switch" onclick="toggleLanguage()">RU | EN</span>
            <span class="profile" onclick="showProfile()">üë§</span>
            <span class="cart" onclick="showCart()">üõí</span>
        </div>
    </div>
    <div class="product-list" id="products"></div>

    <div class="modal-overlay" id="overlay" onclick="hideModals()"></div>
    <div class="profile-modal" id="profileModal">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <img id="avatar" src="/static/default_avatar.jpg" width="100">
        <p id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <button onclick="hideModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="cart-modal" id="cartModal">
        <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
        <div id="cartItems"></div>
        <p>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span id="total">0 ‚ÇΩ</span></p>
        <button onclick="submitOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button onclick="hideModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const Telegram = window.Telegram || {};
        const lang = { ru: { title: "–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤", noProducts: "–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.", error: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏" },
                       en: { title: "Product Catalog", noProducts: "No products added yet.", error: "Loading error" } };
        let currentLang = "ru";

        function toggleLanguage() {
            currentLang = currentLang === "ru" ? "en" : "ru";
            document.querySelector("h2").textContent = lang[currentLang].title;
            loadProducts();
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                if (!response.ok) throw new Error(lang[currentLang].error);
                const products = await response.json();
                const productsDiv = document.getElementById('products');
                productsDiv.innerHTML = products.length
                    ? products.map(p => `
                        <div class="product-item">
                            <strong>${p.name}</strong> (${p.category}) - ${p.price} ‚ÇΩ<br>
                            ${p.description}<br>
                            ${p.images.map(img => `<img src="${img}" width="50">`).join('')}
                            <button onclick="addToCart(${p.id}, '${p.name}', ${p.price})">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
                        </div>
                    `).join('')
                    : lang[currentLang].noProducts;
            } catch (error) {
                document.getElementById('products').innerHTML = `${lang[currentLang].error}: ${error.message}`;
            }
        }

        let cart = [];
        function addToCart(id, name, price) {
            cart.push({ id, name, price, quantity: 1 });
            updateCart();
        }

        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = cart.map(item => `${item.name} x${item.quantity} - ${item.price * item.quantity} ‚ÇΩ`).join('<br>');
            document.getElementById('total').textContent = cart.reduce((sum, item) => sum + item.price * item.quantity, 0) + ' ‚ÇΩ';
        }

        function showProfile() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('profileModal').style.display = 'block';
            fetch('/api/profile')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('username').textContent = data.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    document.getElementById('avatar').src = data.avatar || '/static/default_avatar.jpg';
                });
        }

        function showCart() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('cartModal').style.display = 'block';
            updateCart();
        }

        function submitOrder() {
            if (cart.length === 0) return;
            fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ user_id: Telegram.WebApp.initDataUnsafe?.user?.id || 'unknown', products: JSON.stringify(cart) })
            })
            .then(response => response.json())
            .then(data => alert(data.message))
            .catch(error => alert(`–û—à–∏–±–∫–∞: ${error.message}`));
            cart = [];
            hideModals();
            updateCart();
        }

        function hideModals() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('cartModal').style.display = 'none';
        }

        window.onload = loadProducts;
    </script>
</body>
</html>
